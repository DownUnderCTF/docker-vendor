FROM ubuntu:18.04 as base

FROM base as build
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get -y update \
 && apt-get install -y --no-install-recommends \
      autoconf \
      bison \
      ca-certificates \
      flex \
      gcc \
      g++ \
      git \
      libprotobuf-dev \
      libnl-route-3-dev \
      libtool \
      make \
      pkg-config \
      protobuf-compiler 
 
# hadolint ignore=DL3003,DL3059
RUN git clone https://github.com/google/nsjail.git /nsjail && cd /nsjail && make

FROM base as dist
RUN dpkg --add-architecture i386 \
 && apt-get update \
 && apt-get install -y --no-install-recommends \
     libprotobuf10 \
     libnl-route-3-200 \
     libc6:i386 \
     libstdc++6:i386 \
 && rm -rf /var/lib/apt/lists/*

COPY --from=build /nsjail/nsjail /usr/bin/nsjail
RUN useradd -r -m -u 1000 ctf

COPY docker-entrypoint.sh nsjail-launcher.sh /docker-init/
RUN chmod +x /docker-init/*

ENTRYPOINT ["/docker-init/docker-entrypoint.sh"]
CMD ["/docker-init/nsjail-launcher.sh"]

# copy in example stuff
COPY nsjail.cfg /home/ctf
COPY chal /home/ctf/chal/

